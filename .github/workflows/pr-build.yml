name: PR Build

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-artifact:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
    
    - name: ğŸ” íƒ€ì… ì²´í¬
      run: npm run type-check
    
    - name: ğŸ—ï¸ ê°œë°œ ë¹Œë“œ
      run: npm run build
    
    - name: ğŸ“¤ ê°œë°œ ë¹Œë“œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: LMTools-dev-pr${{ github.event.pull_request.number }}
        path: dist/LMTools.plugin.js
        retention-days: 7
    
    - name: ğŸ’¬ PR ì½”ë©˜íŠ¸ ì¶”ê°€
      uses: actions/github-script@v7
      with:
        script: |
          const artifactUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
          
          const body = `## ğŸ—ï¸ ë¹Œë“œ ì™„ë£Œ!
          
          ê°œë°œ ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ### ğŸ“¦ í…ŒìŠ¤íŠ¸ ë°©ë²•
          
          1. [Actions íƒ­](${artifactUrl})ì—ì„œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
          2. BetterDiscord í”ŒëŸ¬ê·¸ì¸ í´ë”ì— ë³µì‚¬
          3. Discordì—ì„œ í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”
          
          ### ğŸ” ë¹Œë“œ ì •ë³´
          - íƒ€ì… ì²´í¬: âœ… í†µê³¼
          - ê°œë°œ ë¹Œë“œ: âœ… ì„±ê³µ
          - ì•„í‹°íŒ©íŠ¸ ì´ë¦„: \`LMTools-dev-pr${{ github.event.pull_request.number }}\`
          
          âš ï¸ **ì£¼ì˜**: ì´ê²ƒì€ ê°œë°œ ë¹Œë“œì…ë‹ˆë‹¤. ë¯¸ë‹ˆíŒŒì´ë˜ì§€ ì•Šì•˜ìœ¼ë©° ë””ë²„ê¹… ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
          
          // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸°
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('ğŸ—ï¸ ë¹Œë“œ ì™„ë£Œ!')
          );
          
          if (botComment) {
            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }