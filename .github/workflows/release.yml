name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
    
    - name: ğŸ” íƒ€ì… ì²´í¬
      run: npm run type-check
    
    - name: ğŸ­ í”„ë¡œë•ì…˜ ë¹Œë“œ
      run: npm run build:prod
    
    - name: ğŸ“ ë²„ì „ ì •ë³´ ì¶”ì¶œ
      id: version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "VERSION_NUMBER=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: ğŸ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„
      run: |
        mkdir release
        cp dist/LMTools.plugin.js release/
        cd release
        # ì²´í¬ì„¬ ìƒì„±
        sha256sum LMTools.plugin.js > LMTools.plugin.js.sha256
        # ë²„ì „ ì •ë³´ íŒŒì¼ ìƒì„±
        echo "${{ steps.version.outputs.VERSION }}" > VERSION
        cd ..
    
    - name: ğŸ“‹ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
      id: release_notes
      run: |
        # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
        cat > release_notes.md << 'EOF'
        ## ğŸš€ LM Tools ${{ steps.version.outputs.VERSION }}
        
        AI ê¸°ë°˜ Discord ëŒ€í™” ìš”ì•½ í”ŒëŸ¬ê·¸ì¸
        
        ### ğŸ“¦ ì„¤ì¹˜ ë°©ë²•
        
        1. **ì¼ë°˜ ì‚¬ìš©ì**: `LMTools.plugin.js` íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ BetterDiscord í”ŒëŸ¬ê·¸ì¸ í´ë”ì— ë³µì‚¬
           - Windows: `%APPDATA%/BetterDiscord/plugins/`
           - macOS: `~/Library/Application Support/BetterDiscord/plugins/`
           - Linux: `~/.config/BetterDiscord/plugins/`
        
        2. **ê°œë°œì**: ì†ŒìŠ¤ì½”ë“œë¥¼ í´ë¡ í•˜ì—¬ ì§ì ‘ ë¹Œë“œ
           ```bash
           git clone https://github.com/${{ github.repository }}.git
           cd BetterDiscord-LMTools
           npm install
           npm run build:prod
           ```
        
        ### ğŸ” íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦
        
        SHA256 ì²´í¬ì„¬ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì˜ ë¬´ê²°ì„±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
        ```
        EOF
        cat release/LMTools.plugin.js.sha256 >> release_notes.md
        echo '```' >> release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ“ ë³€ê²½ì‚¬í•­" >> release_notes.md
        echo "" >> release_notes.md
        # ì´ì „ íƒœê·¸ë¶€í„° í˜„ì¬ê¹Œì§€ì˜ ì»¤ë°‹ ë¡œê·¸
        git log $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")..HEAD --pretty=format:"- %s" >> release_notes.md || echo "- ì²« ë¦´ë¦¬ìŠ¤" >> release_notes.md
        echo "" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ”— ê´€ë ¨ ë§í¬" >> release_notes.md
        echo "- [ì‚¬ìš© ê°€ì´ë“œ](https://github.com/${{ github.repository }}#-ì„¤ì¹˜-ë°-ì‚¬ìš©)" >> release_notes.md
        echo "- [ê°œë°œì ê°€ì´ë“œ](https://github.com/${{ github.repository }}/blob/main/DEVELOPMENT.md)" >> release_notes.md
        echo "- [ë¬¸ì œ ì‹ ê³ ](https://github.com/${{ github.repository }}/issues)" >> release_notes.md
    
    - name: ğŸ‰ GitHub ë¦´ë¦¬ìŠ¤ ìƒì„±
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/LMTools.plugin.js
          release/LMTools.plugin.js.sha256
        body_path: release_notes.md
        name: LM Tools ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, '-beta') || contains(steps.version.outputs.VERSION, '-alpha') }}